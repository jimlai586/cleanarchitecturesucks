<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>The fall of the house of Clean</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">The fall of the house of Clean</h1>
</header>
<section data-field="subtitle" class="p-summary">
How to spin it when tests show that your Clean Code can’t scale
</section>
<section data-field="body" class="e-content">
<section name="d5d5" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c072" id="c072" class="graf graf--h3 graf--leading graf--title">The fall of the house of Clean</h3><h4 name="ca08" id="ca08" class="graf graf--h4 graf-after--h3 graf--subtitle">How to spin it when tests show that your Clean Code can’t scale</h4><figure name="32ff" id="32ff" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*UspFnautdacr-T3RYjm1zQ.jpeg" data-width="874" data-height="500" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*UspFnautdacr-T3RYjm1zQ.jpeg"><figcaption class="imageCaption">From “the fall of the house of Usher” IMDB</figcaption></figure><h4 name="6c36" id="6c36" class="graf graf--h4 graf-after--figure">Title 18, section 371</h4><blockquote name="b249" id="b249" class="graf graf--blockquote graf-after--h4">Roderick Usher: Here’s to Title 18, Section 371.</blockquote><blockquote name="0d25" id="0d25" class="graf graf--blockquote graf-after--blockquote">Auguste Dupin: Sure. What’s not to celebrate? You got away with it. Again.</blockquote><blockquote name="fa60" id="fa60" class="graf graf--blockquote graf-after--blockquote">Roderick Usher: You know, nobody gets away with anything. Not really.</blockquote><p name="146b" id="146b" class="graf graf--p graf-after--blockquote">I ran across this <a href="https://proandroiddev.com/the-unit-testing-diet-1607aac5f434" data-href="https://proandroiddev.com/the-unit-testing-diet-1607aac5f434" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Testing and refactoring an MVVM app at scale</a> in <em class="markup--em markup--p-em">ProAndroidDev</em>.</p><p name="d050" id="d050" class="graf graf--p graf-after--p">I find it funny because this <em class="markup--em markup--p-em">Staff Engineer </em>cut all corners in testing just so he won’t be crushed by the overheads of <em class="markup--em markup--p-em">Clean Architecture</em>, or as I call it, <strong class="markup--strong markup--p-strong">Bob’s Brute Force Boilerplate. (BBFB)</strong></p><p name="b212" id="b212" class="graf graf--p graf-after--p">It’s scary how the house of <em class="markup--em markup--p-em">Clean Architecture</em> can spin the dumbest shit and sell it to you. Hence the theme.</p><p name="c442" id="c442" class="graf graf--p graf-after--p">Spoiler alert: go watch the show first.</p><p name="eea8" id="eea8" class="graf graf--p graf-after--p">You know what, while we are at it, I’m going to link the show’s theme song on its official <a href="https://www.youtube.com/watch?v=A_7ot3C28OI" data-href="https://www.youtube.com/watch?v=A_7ot3C28OI" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">youtube</a> for maximum immersion.</p><p name="5e23" id="5e23" class="graf graf--p graf-after--p">Oh, and in case you are wondering why a Swift dev bothered to review Android. This is to show how superior Swift is so you will think twice before porting dumb shit from Android.</p><h4 name="fa20" id="fa20" class="graf graf--h4 graf-after--p">It’s time</h4><figure name="548b" id="548b" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*nAIP2Yz-Lc3VbTvvn3LKzQ.png" data-width="1302" data-height="890" src="https://cdn-images-1.medium.com/max/800/1*nAIP2Yz-Lc3VbTvvn3LKzQ.png"><figcaption class="imageCaption">After watching MVVM architecture that enforces Clean Architecture</figcaption></figure><p name="0df0" id="0df0" class="graf graf--p graf-after--figure">I’ll use his code snippet as example. This is view model.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="kotlin" name="8325" id="8325" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatViewModel</span>(<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> getChatMessagesUseCase: GetChatMessagesUseCase,<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sendTextMessageUseCase: SendTextMessageUseCase,<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> user: User<br />) : BaseViewModel() {<br /><br />    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<br />        <span class="hljs-keyword">val</span> messages: List&lt;MessageUiModel&gt;<br />    )<br /><br />    <span class="hljs-keyword">val</span> state: Observable&lt;State&gt;<br />        <span class="hljs-keyword">get</span>() = getChatMessagesUseCase(user).map {<br />            <span class="hljs-keyword">val</span> messageUiModelList = MessageUiModelMapper.fromMessagesList(it)<br />            State(messageUiModelList)<br />        }<br /><br />    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTextMessageSent</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {<br />        sendTextMessageUseCase(text, user).safeSubscribe()<br />    }<br />}</span></pre><p name="7766" id="7766" class="graf graf--p graf-after--pre">This is a use case.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="kotlin" name="6855" id="6855" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GetChatMessagesUseCase</span>(<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> chatMessagesRepository: ChatMessagesRepository<br />) {<br /><br />    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invoke</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span>: Observable&lt;List&lt;Message&gt;&gt; {<br />        <span class="hljs-keyword">return</span> chatMessagesRepository.getChatMessages(user).map { messagesList -&gt;<br />            messagesList.sortedBy { it.date.time }<br />        }<br />    }<br />}</span></pre><p name="0ab4" id="0ab4" class="graf graf--p graf-after--pre">In case you didn’t recognize this pattern, this is textbook <strong class="markup--strong markup--p-strong">BRUTE FORCE</strong>. None of these shit are reusable, everything is hard-coded while pretending to be otherwise.</p><p name="f4c6" id="f4c6" class="graf graf--p graf-after--p">To test this view model, you have to supply use cases, which are glorified closures. And as if this isn’t already difficult to mock, he has to bury it in a <code class="markup--code markup--p-code">map</code> of an observable in a hard-coded repository in a generalized <code class="markup--code markup--p-code">invoke</code> function.</p><p name="6573" id="6573" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">messageList.sortedBy {it.date.time}</code> is the only meaningful line in all of these boilerplate.</p><p name="0c98" id="0c98" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">You are fuk, as shown by the sheer difficulty of mocking this.</strong></p><p name="0f98" id="0f98" class="graf graf--p graf-after--p">Now, a good dev will go back to drawing board. Because whatever this is ain’t working.</p><p name="9d8a" id="9d8a" class="graf graf--p graf-after--p">But a <em class="markup--em markup--p-em">Staff Engineer</em> is beyond that. He is going to double down and quote from the house of Bob.</p><blockquote name="a4f3" id="a4f3" class="graf graf--blockquote graf-after--p">What do the experts say?</blockquote><blockquote name="ff8c" id="ff8c" class="graf graf--blockquote graf-after--blockquote">See here what the most recognized and experienced software engineers with unit tests, including Martin Fowler, Uncle Bob, Kent Beck, and Ian Cooper, say about mocks.</blockquote><p name="1382" id="1382" class="graf graf--p graf-after--blockquote">You know what these experts have in common? None of them are Swift devs.</p><p name="19f5" id="19f5" class="graf graf--p graf-after--p">Let’s rewrite this in Swift.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="less" name="e3a3" id="e3a3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-selector-tag">struct</span> <span class="hljs-selector-tag">Model</span>: <span class="hljs-selector-tag">View</span> {<br />  <span class="hljs-variable">@State</span> var messageList = [MessageList]()<br />  <span class="hljs-variable">@StateObject</span> var service = <span class="hljs-built_in">Service</span>() <span class="hljs-comment">// some service to get message list</span><br />  func <span class="hljs-built_in">transfrom</span>(_ <span class="hljs-attribute">before</span>: [MessageList]) -&gt; [MessageList] {<br />      <span class="hljs-comment">// sort it</span><br />  }<br />}</span></pre><p name="4ca0" id="4ca0" class="graf graf--p graf-after--pre">Does model <code class="markup--code markup--p-code">messageList</code> change trigger view update? Yes.</p><p name="8cec" id="8cec" class="graf graf--p graf-after--p">Are most of the properties / arguments simple value type? Yes.</p><p name="6570" id="6570" class="graf graf--p graf-after--p">Can <code class="markup--code markup--p-code">transform</code> be unit tested easily? Yes. It’s pure function.</p><p name="66ec" id="66ec" class="graf graf--p graf-after--p">Instead of dumb shit <code class="markup--code markup--p-code">UseCase</code> , we can write <code class="markup--code markup--p-code">TestCase</code> directly:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="5d79" id="5d79" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Service</span> {<br />  <span class="hljs-keyword">func</span> <span class="hljs-title function_">getMockChatMsg</span>() -&gt; [<span class="hljs-type">MessageList</span>] {<span class="hljs-operator">...</span>}<br />}<br /><br /><span class="hljs-keyword">func</span> <span class="hljs-title function_">testChatMsg</span>() {<br />  <span class="hljs-keyword">let</span> service <span class="hljs-operator">=</span> <span class="hljs-type">Service</span>()<br />  <span class="hljs-keyword">var</span> msgList <span class="hljs-operator">=</span> service.getMockChatMsg()<br />  <span class="hljs-keyword">var</span> model <span class="hljs-operator">=</span> <span class="hljs-type">Model</span>(messageList: msgList)<br />  <span class="hljs-comment">// test it</span><br />}<br />  </span></pre><p name="30a1" id="30a1" class="graf graf--p graf-after--pre">Take some time to compare the differences.</p><p name="0252" id="0252" class="graf graf--p graf-after--p">I hope by now you are feeling something refreshing, as if things are not… <strong class="markup--strong markup--p-strong">NESTED</strong>? <strong class="markup--strong markup--p-strong">COUPLED</strong>?</p><p name="fae7" id="fae7" class="graf graf--p graf-after--p">As if there are no… what’s the word?</p><p name="19d0" id="19d0" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">DEPENDENCIES</strong>?</p><p name="17fa" id="17fa" class="graf graf--p graf-after--p">If I could write better code without even the notion of dependency, what benefits do you bring by adding extra complexity?</p><p name="0490" id="0490" class="graf graf--p graf-after--p">It is time for the house of <em class="markup--em markup--p-em">Clean</em> to fall.</p><p name="3798" id="3798" class="graf graf--p graf-after--p">For entertainment value, let’s observe how a staff engineer goes through hoops of mental gymnastics to cope with extra complexity.</p><h4 name="aeed" id="aeed" class="graf graf--h4 graf-after--p">A world without pain</h4><blockquote name="183e" id="183e" class="graf graf--blockquote graf-after--h4">A world without pain — that was the whole point.</blockquote><blockquote name="7795" id="7795" class="graf graf--blockquote graf-after--blockquote">I sent her off like a queen. Quen Twosret, as a matter of fact.</blockquote><blockquote name="dedf" id="dedf" class="graf graf--blockquote graf-after--blockquote">I’m sorry for all the times I’ve inconvenienced you.</blockquote><blockquote name="dfbd" id="dfbd" class="graf graf--blockquote graf-after--blockquote">We may not have been perfect, but you can say we definitely changed the world.</blockquote><blockquote name="4415" id="4415" class="graf graf--blockquote graf-after--blockquote">I knew, deep down in the witching hour. I knew.</blockquote><blockquote name="416a" id="416a" class="graf graf--blockquote graf-after--blockquote">There’s no such thing as a <strong class="markup--strong markup--blockquote-strong">DEPENDENCY</strong>. Imagine if we put <strong class="markup--strong markup--blockquote-strong">DEPENDENCY INJECTION</strong> on the bottle. I bet I could’ve still sold it.</blockquote><p name="ea3d" id="ea3d" class="graf graf--p graf-after--blockquote">If you haven’t watched the show. Here’s some context.</p><p name="0b38" id="0b38" class="graf graf--p graf-after--p">Roderick made money by selling painkiller drugs that are supposed to be without side effects.</p><p name="de87" id="de87" class="graf graf--p graf-after--p">As you would have guessed, it is full of side effects, and he has to cover it.</p><p name="f7cd" id="f7cd" class="graf graf--p graf-after--p">So what drug is Bob selling?</p><blockquote name="b6e7" id="b6e7" class="graf graf--blockquote graf-after--p">Our tests become “overspecified” which means that they contain assumptions on how the code under test is implemented, <strong class="markup--strong markup--blockquote-strong">causing the tests to break if the implementation changes.</strong></blockquote><p name="18a9" id="18a9" class="graf graf--p graf-after--blockquote">That your code is not hard-coded in any significant way. It will be modular and flexible and other shit. Yet it breaks immediately when you try to test it.</p><p name="fb23" id="fb23" class="graf graf--p graf-after--p">Correct me if I’m wrong, what’s the technical term?</p><p name="7ccf" id="7ccf" class="graf graf--p graf-after--p">It sounds like you <strong class="markup--strong markup--p-strong">depend on your dependencies</strong>? Let’s hear from staff engineer:</p><blockquote name="17ba" id="17ba" class="graf graf--blockquote graf-after--p">Mocks bind you to a specific dependency graph.</blockquote><p name="1c37" id="1c37" class="graf graf--p graf-after--blockquote">Huh. This is complete bullshit. Because</p><ol class="postList"><li name="fabe" id="fabe" class="graf graf--li graf-after--p">You have to commit to a specific graph in production code, <em class="markup--em markup--li-em">eventually</em>.</li></ol><figure name="095f" id="095f" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*y5JSqOyFFTfoFM9TuQeLJw.jpeg" data-width="500" data-height="500" src="https://cdn-images-1.medium.com/max/800/1*y5JSqOyFFTfoFM9TuQeLJw.jpeg"></figure><p name="cb5c" id="cb5c" class="graf graf--p graf-after--figure">2. Since you take one, you test it, right?</p><p name="df26" id="df26" class="graf graf--p graf-after--p">I love this notion of having infinite possibilities, as if nothing is fixed, and there’s no pain for implementation changes.<em class="markup--em markup--p-em"> A world without pain</em>.</p><p name="196c" id="196c" class="graf graf--p graf-after--p">Look at his example:</p><blockquote name="53d8" id="53d8" class="graf graf--blockquote graf-after--p">You have a Class A depending on Class B &amp; Class C. You’re testing Class A by mocking Class B and Class C. Then you realize that the design becomes simpler if you refactor by moving Class C under Class B. Now tests in Class A are broken, despite not changing its external behavior.</blockquote><p name="26c4" id="26c4" class="graf graf--p graf-after--blockquote">His tests break because <code class="markup--code markup--p-code">classA(b, c)</code> becomes <code class="markup--code markup--p-code">classA(b(c))</code> .</p><p name="c4cf" id="c4cf" class="graf graf--p graf-after--p">Well, because you change function signature. Use IDE to change signature in one click.</p><p name="6a1e" id="6a1e" class="graf graf--p graf-after--p">You see, this is too brute force. We can’t have that. That’s why we are not staff engineer.</p><p name="5c71" id="5c71" class="graf graf--p graf-after--p">Here’s how a staff engineer enpowered with the experiences of most recognized and experienced software engineers like Martin Fowler, Uncle Bob, Kent Beck, and Ian Cooper would do:</p><blockquote name="6ed3" id="6ed3" class="graf graf--blockquote graf-after--p">This pattern makes each test to be tied to the actual implementation. <strong class="markup--strong markup--blockquote-strong">Why do I need to know the dependencies</strong> of the ViewModel in order to test it? I want to test the feature by<strong class="markup--strong markup--blockquote-strong"> providing an input and evaluating the output</strong>. <strong class="markup--strong markup--blockquote-strong">By mocking every dependency</strong>, we’re not testing the behavior as we want in BDD, <strong class="markup--strong markup--blockquote-strong">we’re just testing the internal implementation.</strong></blockquote><p name="4bd0" id="4bd0" class="graf graf--p graf-after--blockquote">Instead of mocking every dependency, let’s not mock any of them. I want to unit test so hard that I skip it entirely. It would be just testing internal implementation anyway, who gives a shit right?</p><p name="93ff" id="93ff" class="graf graf--p graf-after--p">Now would be a good time to play the theme song from 1 minute mark. Because the house of <em class="markup--em markup--p-em">Clean</em> is crumbling.</p><p name="e599" id="e599" class="graf graf--p graf-after--p">Why do I need to know the dependencies? Because you explicity expose them and sell it as pain killer!!! The cover up!</p><p name="dda6" id="dda6" class="graf graf--p graf-after--p">Obviously he is then going to change the definition of “unit test”. You can see it from miles away.</p><blockquote name="d658" id="d658" class="graf graf--blockquote graf-after--p">Is this a unit test or an integration test?</blockquote><blockquote name="2be2" id="2be2" class="graf graf--blockquote graf-after--blockquote">To give insight on this interesting and debatable topic, we’ll first leverage the wisdom of the experts in the field:</blockquote><p name="b512" id="b512" class="graf graf--p graf-after--blockquote">We can take this moment to see what kind of vague, ambiguious, useless terms you need to come up with for a coding architecture book</p><blockquote name="aea6" id="aea6" class="graf graf--blockquote graf-after--p">Martin Fowler defines a distinction between <strong class="markup--strong markup--blockquote-strong">sociable</strong> tests and <strong class="markup--strong markup--blockquote-strong">solitary</strong> tests in his excellent articles on unit tests and on the “misshapen” test pyramid.</blockquote><p name="ef77" id="ef77" class="graf graf--p graf-after--blockquote">Sociable. Solitary. Test pyramid. My cat turned into a TDD titan after reading this.</p><p name="9392" id="9392" class="graf graf--p graf-after--p">Anyway, the end result is to just test view model which can magically cover all other shit.</p><blockquote name="d572" id="d572" class="graf graf--blockquote graf-after--p">So since we’ll test the ViewModel, does that mean that our UseCases and Repository will be untested? No and that’s the key. <strong class="markup--strong markup--blockquote-strong">Those layers will be covered for free by the BDD tests of the ViewModel</strong>. In other words, our <strong class="markup--strong markup--blockquote-strong">UseCases and Repositories can have any implementation we wish</strong>.</blockquote><p name="617f" id="617f" class="graf graf--p graf-after--blockquote">First there’s nothing stopping your <code class="markup--code markup--p-code">UseCases</code> and <code class="markup--code markup--p-code">Repositories</code> to have any implementation you want in the first place. They are dedicated objects with insane overheads to do just that.</p><p name="247d" id="247d" class="graf graf--p graf-after--p">Second, that literally means your view model <strong class="markup--strong markup--p-strong">depends</strong> on specific <code class="markup--code markup--p-code">UseCases</code> and <code class="markup--code markup--p-code">Repository</code> . They are <strong class="markup--strong markup--p-strong">coupled </strong>together!</p><p name="1cc0" id="1cc0" class="graf graf--p graf-after--p">I’ll ask for a refund for Martin Fowler’s book if I were you.</p><p name="19f9" id="19f9" class="graf graf--p graf-after--p">The house of the most recognized and experienced software engineers like Martin Fowler, Uncle Bob, Kent Beck, and Ian Cooper:</p><figure name="9979" id="9979" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*nqKY5cz8G8ZW90BzN5EF3A.png" data-width="1317" data-height="988" src="https://cdn-images-1.medium.com/max/800/1*nqKY5cz8G8ZW90BzN5EF3A.png"></figure><p name="4d9c" id="4d9c" class="graf graf--p graf-after--figure">Third! For free? Give me a fking break. That only means they are part of the tests for view model instead of having their own. You still write them! The fact that they can’t have their own tests shows that they are coupled!</p><p name="cac0" id="cac0" class="graf graf--p graf-after--p">A world without pain must be full of lies. Speaking of which, did you find the side effects?</p><h4 name="ecb0" id="ecb0" class="graf graf--h4 graf-after--p">Nobody knows they’re the fall guy until they’re falling</h4><blockquote name="0606" id="0606" class="graf graf--blockquote graf-after--h4">Auguste Dupin: Was it ever going to be enough? How much money would make you say, “We did it”? Does that number even exist?</blockquote><blockquote name="2047" id="2047" class="graf graf--blockquote graf-after--blockquote">Roderick Usher: That’s an idiot question. Of course not.</blockquote><p name="8c97" id="8c97" class="graf graf--p graf-after--blockquote">Auguste Dupin is the polar opposite of Roderick Usher. Dupin had been trying to prosecute Roderick for years.</p><p name="72fd" id="72fd" class="graf graf--p graf-after--p">Like Dupin, I’m the polar opposite of an Android staff engineer that writes BDD on the shoulders of titans like Martin Fowler, Uncle Bob, Kent Beck, and Ian Cooper.</p><p name="1168" id="1168" class="graf graf--p graf-after--p">But if your BDD works, I should have no problem understanding what you are testing, right?</p><p name="b2e1" id="b2e1" class="graf graf--p graf-after--p">So what is he testing?</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="kotlin" name="dfda" id="dfda" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><br /><br />            When(<span class="hljs-string">&quot;I send a text message&quot;</span>) {<br />                <span class="hljs-keyword">var</span> textMessage = <span class="hljs-string">&quot;&quot;</span><br />                beforeEach {<br />                    viewModel.onTextMessageSent(textMessage)<br />                }<br /><br />                And(<span class="hljs-string">&quot;It is valid&quot;</span>) {<br />                    textMessage = <span class="hljs-string">&quot;2nd message&quot;</span><br /><br />                    Then(<span class="hljs-string">&quot;It is displayed&quot;</span>) {<br />                        stateObserver.lastValue() shouldBeEqualTo ChatViewModel.State(<br />                            messages = listOf(<br />                                MessageUiModel(text = <span class="hljs-string">&quot;1st message&quot;</span>, type = Message.Type.Received),<br />                                MessageUiModel(text = <span class="hljs-string">&quot;2nd message&quot;</span>, type = Message.Type.Pending)<br />                            )<br />                        )<br />                    }<br />                }<br />            }</span></pre><p name="a7d8" id="a7d8" class="graf graf--p graf-after--pre">Well, if you change <code class="markup--code markup--p-code">textMessage</code> , then check if it is displayed by checking some property.</p><p name="2470" id="2470" class="graf graf--p graf-after--p">But note that <code class="markup--code markup--p-code">textMessage</code> is a local variable, how does it affect view model?</p><p name="5632" id="5632" class="graf graf--p graf-after--p">When you set <code class="markup--code markup--p-code">textMessage = &quot;2nd message&quot;</code> , there’s a state change in view model without you explicitly feeding it to view model.</p><p name="5b7a" id="5b7a" class="graf graf--p graf-after--p">If you come from Swift, <code class="markup--code markup--p-code">textMessage</code> would be a value type. You need some serious side effects to work like that.</p><p name="9dcf" id="9dcf" class="graf graf--p graf-after--p">Since you are not explicitly calling anything associated with view model instance, it’s probably some library magic. But in that case how do you know you are not just testing library magic?</p><p name="c962" id="c962" class="graf graf--p graf-after--p">It will make things more clearly by rewriting it in Swift:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="swift" name="a39a" id="a39a" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Model</span>: <span class="hljs-title class_">View</span> {<br />  <span class="hljs-meta">@State</span> <span class="hljs-keyword">var</span> text <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><br />  <span class="hljs-keyword">var</span> computedState: <span class="hljs-type">String</span> { <span class="hljs-operator">...</span> }<br />}<br /><span class="hljs-keyword">var</span> text <span class="hljs-operator">=</span> <span class="hljs-string">&quot;2nd message&quot;</span><br /><span class="hljs-keyword">var</span> model <span class="hljs-operator">=</span> <span class="hljs-type">Model</span>(text)<br /><span class="hljs-comment">// check model.text == text?</span><br /><span class="hljs-comment">// check model.computedState?</span></span></pre><p name="631b" id="631b" class="graf graf--p graf-after--pre">The library magic is <code class="markup--code markup--p-code">Model(text)</code> , i.e.; it passes <code class="markup--code markup--p-code">text</code> to <code class="markup--code markup--p-code">model</code> instance. If you check <code class="markup--code markup--p-code">model.text == text</code> , then it’s trivial and you are just testing library; if you check <code class="markup--code markup--p-code">model.computedState</code> then why not focus on it? Like unit test?</p><p name="c1bf" id="c1bf" class="graf graf--p graf-after--p">If you can specify this</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="kotlin" name="9410" id="9410" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">stateObserver.lastValue() shouldBeEqualTo ChatViewModel.State(<br />  messages = listOf(<br />    MessageUiModel(text = <span class="hljs-string">&quot;1st message&quot;</span>, type = Message.Type.Received),<br />    MessageUiModel(text = <span class="hljs-string">&quot;2nd message&quot;</span>, type = Message.Type.Pending)<br />  )<br />)</span></pre><p name="d2ff" id="d2ff" class="graf graf--p graf-after--pre">Then you bloody know the implementation detail already!</p><p name="22f2" id="22f2" class="graf graf--p graf-after--p">On the other hand, note that there’s one view model for every view. (this is wrong, but tell it to view model monkeys) So how many times you need to repeat this BDD? To check all kinds of view update? To repeatedly check if library works?</p><p name="3e77" id="3e77" class="graf graf--p graf-after--p">My opinion is that none of these are meaningful tests. The thing about view is that if you got it wrong, you can see it. There might be some edge cases if you don’t have a single source of view model, but you have it, right?</p><p name="884b" id="884b" class="graf graf--p graf-after--p">You check view model update in development, and there’s only one place for that, the rest is UI test. That saves you what, 30 lines in his test multiplied by the average tests in one view multiplied by number of views?</p><p name="bfa0" id="bfa0" class="graf graf--p graf-after--p">Which brings another question, if view update is changed in anyway, e.g.; view is only updated after receiving 5 messages, your tests break. So in the end he failed at what he set out to do:</p><blockquote name="f6b8" id="f6b8" class="graf graf--blockquote graf-after--p">Our tests become “<strong class="markup--strong markup--blockquote-strong">overspecified</strong>” which means that they contain assumptions on how the code under test is implemented, <strong class="markup--strong markup--blockquote-strong">causing the tests to break if the implementation changes.</strong></blockquote><p name="17f7" id="17f7" class="graf graf--p graf-after--blockquote">A solution to a problem that doesn’t exist, which creates a recursive problem in the process, that ends up not solving anything.</p><p name="5117" id="5117" class="graf graf--p graf-after--p">It’s beautiful. It’s like poetry, they rhyme.</p><p name="dc30" id="dc30" class="graf graf--p graf-after--p">What he should do instead is a unit test on non-trivial state changes:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="swift" name="ddb9" id="ddb9" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">var</span> text <span class="hljs-operator">=</span> <span class="hljs-string">&quot;2nd message&quot;</span><br /><span class="hljs-keyword">var</span> model <span class="hljs-operator">=</span> <span class="hljs-type">Model</span>(text)<br /><span class="hljs-comment">// check model.computedState</span></span></pre><p name="8c3a" id="8c3a" class="graf graf--p graf-after--pre">But basics don’t sell. He continued to make a long list of imaginary benefits. Let’s look at one.</p><blockquote name="bc77" id="bc77" class="graf graf--blockquote graf-after--p">The biggest one is that <strong class="markup--strong markup--blockquote-strong">we test the behavior and not the implementation</strong>. If you noticed in our BDD test suite w<strong class="markup--strong markup--blockquote-strong">e’re only injecting the </strong><code class="markup--code markup--blockquote-code"><strong class="markup--strong markup--blockquote-strong">ChatViewModel</strong></code><strong class="markup--strong markup--blockquote-strong"> and not the UseCases or the Repository.</strong> This means that our tests are <strong class="markup--strong markup--blockquote-strong">decoupled </strong>from the actual implementation and the implementation can change without updating the tests. Thus, <strong class="markup--strong markup--blockquote-strong">we enable refactoring.</strong></blockquote><p name="56de" id="56de" class="graf graf--p graf-after--blockquote">He and I have very different definition of the word “<strong class="markup--strong markup--p-strong">decoupled</strong>”. BBFB is worthless, but what is the technical term in BBFB about having hard-coded (c.f. not injected) <code class="markup--code markup--p-code">UseCases</code> , hmm… , <em class="markup--em markup--p-em">dependency</em>?</p><p name="cb16" id="cb16" class="graf graf--p graf-after--p">He is doing the exact opposite of what he preaches and spinning it so hard that he can power America by himself.</p><p name="d7cb" id="d7cb" class="graf graf--p graf-after--p">Hey it’s OK some of them don’t need to be injected. Then why not all of them? What the F is the value of this extra complexity when you can do just fine without it? BBFB told people to identify, if I remember correctly, <strong class="markup--strong markup--p-strong">tight coupling</strong>!!! Which is it? Tight coupling or <strong class="markup--strong markup--p-strong">decoupled</strong>?</p><p name="2d77" id="2d77" class="graf graf--p graf-after--p">As for “we are only injecting the <code class="markup--code markup--p-code">ChatViewModel</code>”, this is the only place I can find:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="csharp" name="5965" id="5965" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">private</span> val viewModel: <span class="hljs-function">ChatViewModel <span class="hljs-keyword">by</span> <span class="hljs-title">inject</span>()</span></span></pre><p name="b73f" id="b73f" class="graf graf--p graf-after--pre">Recall that this is the class definition:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="kotlin" name="3549" id="3549" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatViewModel</span>(<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> getChatMessagesUseCase: GetChatMessagesUseCase,<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sendTextMessageUseCase: SendTextMessageUseCase,<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> user: User<br />) : BaseViewModel() {</span></pre><p name="451f" id="451f" class="graf graf--p graf-after--pre">Library magic? How do you initialize a <code class="markup--code markup--p-code">ChatViewModel</code> for injection without explicitly specifying it?</p><p name="c928" id="c928" class="graf graf--p graf-after--p">Either he specified it somewhere but didn’t show it (e.g.; register via container) or there’s a default. (unless Kotlin initialization is nothing like Swift)</p><p name="33d9" id="33d9" class="graf graf--p graf-after--p">What he claimed as benefits are either imaginary, contradictory, or hidden from direct verification.</p><blockquote name="dfd3" id="dfd3" class="graf graf--blockquote graf-after--p">If you run the test suite above with coverage, you’ll notice that it’s covering 100% of the code in the ViewModel, in its UseCases and in the Repository, including their dependencies such as the <code class="markup--code markup--blockquote-code">MessageUiModelMapper</code> and the <code class="markup--code markup--blockquote-code">MessageFactory</code>.</blockquote><p name="0e46" id="0e46" class="graf graf--p graf-after--blockquote">And if you trace it, it’s probably manually registered somewhere via some container framework. Don’t even get me started on dumb shit <code class="markup--code markup--p-code"><em class="markup--em markup--p-em">MessageUiModelMapper</em></code><em class="markup--em markup--p-em"> </em>which should be a function and the singleton abuse <code class="markup--code markup--p-code">MessageFactory</code> .</p><p name="7a1b" id="7a1b" class="graf graf--p graf-after--p">The clown jewel, sorry, I mean crown jewel is this:</p><blockquote name="3758" id="3758" class="graf graf--pullquote graf-after--p">Thus, we enable <strong class="markup--strong markup--pullquote-strong">refactoring</strong>.</blockquote><p name="3b6c" id="3b6c" class="graf graf--p graf-after--pullquote">First, he didn’t refactor for shit. Everything is hard-coded boilerplate. His “refactor” is just re-arranging dependency graph.</p><p name="b8c9" id="b8c9" class="graf graf--p graf-after--p">Second, all he did is remove / hide injection. If this is <strong class="markup--strong markup--p-strong">enable refactoring</strong>, that means DI disables refactoring, which explains why it’s full of hard-coded boilerplate!</p><p name="f89e" id="f89e" class="graf graf--p graf-after--p">Third, if your tests break from refactoring, you are probably doing it wrong. He can’t even change view update without breaking it!</p><p name="b739" id="b739" class="graf graf--p graf-after--p">Do you realize you are falling?</p><h4 name="c8fd" id="c8fd" class="graf graf--h4 graf-after--p">Nevermore</h4><blockquote name="c619" id="c619" class="graf graf--blockquote graf-after--h4">Was it ever going to be enough? Over the years, I’ve talked to a lot of people who have taken your drugs. Soccer moms with headaches. Accountants with carpal tunnel. Kids with sports injuries. Their docs prescribe them Ligodone, pitch it like extra strength Tylenol. Fast forward a year, they’re shooting up heroin behind dumpsters. Or they’re dead.</blockquote><blockquote name="45a6" id="45a6" class="graf graf--blockquote graf-after--blockquote">— Auguste Dupin</blockquote><p name="97b2" id="97b2" class="graf graf--p graf-after--blockquote">BBFB is like Ligodone. Clean without side effects. Modular and flexible, <em class="markup--em markup--p-em">a world without pain</em>.</p><p name="e3ac" id="e3ac" class="graf graf--p graf-after--p">Then watch some staff engineer can’t even make it work without dropping dependencies, and changing the definition of “unit test”.</p><p name="19ac" id="19ac" class="graf graf--p graf-after--p">But the spooky thing is that this dumb shit can somehow slip through the cracks.</p><blockquote name="d9ed" id="d9ed" class="graf graf--blockquote graf-after--p">This family has repeatedly managed to evade prosecution, no matter how much evidence is stacked against them, no matter how many testified, no matter how many bodies they pile up, they always slip through the cracks.</blockquote><p name="0580" id="0580" class="graf graf--p graf-after--blockquote">In the show, Roderick made a deal with the devil. He can evade all prosecutions until the time has come.</p><p name="98ac" id="98ac" class="graf graf--p graf-after--p">Roderick’s drug somehow gets FDA approval, despite all the obvious side effects. Same as BBFB, except FDA is Google.</p><p name="225a" id="225a" class="graf graf--p graf-after--p">Coincidence? I think not.</p><p name="f511" id="f511" class="graf graf--p graf-after--p">Has the time come? I think not.</p><p name="8176" id="8176" class="graf graf--p graf-after--p">MVVM devs are still pumping tutorials on creating view model in SwiftUI after what, a decade? I think I’m still the only one on Internet that says <code class="markup--code markup--p-code">struct Model: View</code> is a model, not view.</p><p name="2ef2" id="2ef2" class="graf graf--p graf-after--p">Where’s the view properties? Like <code class="markup--code markup--p-code">backgroundColor</code> ? This should be objective answer. But no. It’s always MVVM devs pumping shit that fits their narrative.</p><p name="ed70" id="ed70" class="graf graf--p graf-after--p">Look at staff engineer. On one hand he said view model only handles view state. But on the other hand you can test everything by testing view model.</p><p name="f95e" id="f95e" class="graf graf--p graf-after--p">Then your view model contains everything!</p><p name="3068" id="3068" class="graf graf--p graf-after--p">Let’s hope that one day we can see the fall of the house of <em class="markup--em markup--p-em">Clean</em>.</p><figure name="3773" id="3773" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*KfDantN8jXWUwvkhR2dsDQ.png" data-width="855" data-height="560" src="https://cdn-images-1.medium.com/max/800/1*KfDantN8jXWUwvkhR2dsDQ.png"><figcaption class="imageCaption">Clean Architecture</figcaption></figure><p name="6ad0" id="6ad0" class="graf graf--p graf-after--figure">Oh, he had these two sections.</p><blockquote name="3fce" id="3fce" class="graf graf--blockquote graf-after--p">More in this series</blockquote><blockquote name="5594" id="5594" class="graf graf--blockquote graf-after--blockquote">The Unit Testing Diet: Start with BDD and Do Not Mock<em class="markup--em markup--blockquote-em"> ← you are here</em></blockquote><blockquote name="bb7e" id="bb7e" class="graf graf--blockquote graf-after--blockquote">Addendum: Unit Testing Experts on Mocks</blockquote><blockquote name="8a98" id="8a98" class="graf graf--blockquote graf-after--blockquote">The Unit Testing Diet Part II: DRY code with Test Factories</blockquote><blockquote name="2c16" id="2c16" class="graf graf--blockquote graf-after--blockquote">About the author</blockquote><p name="990d" id="990d" class="graf graf--p graf-after--blockquote">I want to do the same.</p><h4 name="0878" id="0878" class="graf graf--h4 graf-after--p">More in this series</h4><p name="bf85" id="bf85" class="graf graf--p graf-after--h4">Addendum: Epic mistakes on mocks</p><p name="a6f9" id="a6f9" class="graf graf--p graf-after--p">The Unit Testing Diet Part II: Why Test Factories are full of shit</p><h4 name="d0cd" id="d0cd" class="graf graf--h4 graf-after--p">About the author</h4><p name="27a9" id="27a9" class="graf graf--p graf-after--h4 graf--trailing">I watch horror shows on Netflix.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@swift2931" class="p-author h-card">Jim Lai</a> on <a href="https://medium.com/p/74afa19644ec"><time class="dt-published" datetime="2023-11-04T14:44:01.094Z">November 4, 2023</time></a>.</p><p><a href="https://medium.com/@swift2931/the-fall-of-the-house-of-clean-74afa19644ec" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 9, 2023.</p></footer></article></body></html>